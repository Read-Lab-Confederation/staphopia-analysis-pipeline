#! /usr/bin/env python
""" Count kmers in an input FASTQ file. """
from ruffus import *

from staphopia.tasks import kmer

parser = cmdline.get_argparse(description='Count kmers in a FASTQ file.')
parser.add_argument("-f", "--fastq", dest="fastq", help="Input FASTQ file",
                    required=True)
parser.add_argument('-p', '--processors', metavar="INT", type=int, default=1,
                    help='Number of processors to use. (Default 1)')
options = parser.parse_args()
VERSION = '0.1'

# Pipeline --------------------------------------------------------------------


@transform(options.fastq, regex(r"(.*).cleanup.fastq.gz"), r"\1.jf")
def count(input_file, output_file):
    """ Count kmers using Jellyfish. """
    kmer.jellyfish_count(input_file, output_file, str(options.processors))


@follows(count)
@transform(count, regex(r"(.*).jf"), r"\1.kmer_count.gz")
def dump(input_file, output_file):
    """ Dump kmer counts into a text file. """
    kmer.jellyfish_dump(input_file, output_file)

# -----------------------------------------------------------------------------
pipeline_run(exceptions_terminate_immediately=True, verbose=5)
