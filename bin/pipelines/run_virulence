#! /usr/bin/env python
from ruffus import *

from staphopia.tasks import virulence
from staphopia.config import *

parser = cmdline.get_argparse(description='WHAT DOES THIS PIPELINE DO?')
parser.add_argument("--blastdb", dest="blastdb", required=True,
                    help="BLAST database to query genes against.")
parser.add_argument('-p', '--processors', metavar="INT", type=int, default=1,
                  help='Number of processors to use. (Default 1)')
options = parser.parse_args()

config = {
    'n_cpu':str(options.processors),
    'virulence_genes':BASE_DIR+'/tool-data/virulence_genes.fasta',
    'tblastn':THIRD_PARTY_PATH+'/tblastn',
}

blastdb_exists = options.blastdb + ".out"

# Pipeline --------------------------------------------------------------------
@mkdir('virulence')   
@transform(blastdb_exists, regex(r"(.*)"), r"virulence/completed")
def blast_genes(blastdb, output_file):
    results = virulence.blast_genes(options.blastdb, output_file, config)

# -----------------------------------------------------------------------------
pipeline_run(exceptions_terminate_immediately = True, verbose=5)