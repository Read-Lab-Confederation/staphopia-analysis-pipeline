#! /usr/bin/env python
""" Call SNPs and InDels from the input FASTQ. """
import sys
from os.path import dirname

from ruffus import *

from staphopia.helpers.time_job import time_job
from staphopia.tasks import snp, shared

parser = cmdline.get_argparse(description='Call variants from input FASTQ.')
parser.add_argument("-f", "--fastq", dest="fastq", help="Input FASTQ file",
                    required=True)
parser.add_argument('-p', '--processors', metavar="INT", type=int, default=1,
                    help='Number of processors to use. (Default 1)')
parser.add_argument('--tag', help='Prefix for final VCF. (Default variants)',
                    dest='tag', default='variants')
parser.add_argument('--log_times', action='store_true', default=False,
                    help='Write task run times to file (Default: STDERR).', )
options = parser.parse_args()

TIME_LOG = 'logs/call_variants.time' if options.log_times else sys.stderr
# Pipeline --------------------------------------------------------------------


@active_if(options.log_times)
def create_dir():
    """ Make logs directory if required. """
    out, err = shared.run_command(['mkdir', 'logs'])


@mkdir('snp/completed')
@mkdir('snp/gatk')
@transform(options.fastq, regex(r"(.*)"), r"snp/completed/variants.sai")
@time_job(TIME_LOG, new_stream=True)
def bwa_aln(input_file, output_file):
    """ Align reads using BWA. """
    output_sai = output_file.replace('completed', 'gatk')
    snp.bwa_aln(options.fastq, output_sai, output_file,
                str(options.processors))


@follows(bwa_aln)
@transform(bwa_aln, regex(r"(.*).sai"), r"\1.sam")
@time_job(TIME_LOG)
def bwa_samse(input_file, output_file):
    """ Align as single-end reads. """
    input_sai = input_file.replace('completed', 'gatk')
    output_sam = output_file.replace('completed', 'gatk')
    snp.bwa_samse(input_sai, options.fastq, output_sam, output_file)


@follows(bwa_samse)
@transform(bwa_samse, regex(r"(.*).sam"), r"\1.bam")
@time_job(TIME_LOG)
def sam_to_bam(input_file, output_file):
    """ Convert SAM to BAM. """
    input_sam = input_file.replace('completed', 'gatk')
    output_bam = output_file.replace('completed', 'gatk')
    snp.sam_to_bam(input_sam, output_bam, output_file)


@follows(sam_to_bam)
@transform(sam_to_bam, regex(r"(.*).bam"), r"\1_s.bam")
@time_job(TIME_LOG)
def add_or_replace_read_groups(input_file, output_file):
    """ Filter out reads. """
    input_bam = input_file.replace('completed', 'gatk')
    output_bam = output_file.replace('completed', 'gatk')
    snp.add_or_replace_read_groups(input_bam, output_bam, output_file)


@follows(add_or_replace_read_groups)
@transform(add_or_replace_read_groups, regex(r"(.*).bam"), r"\1.index")
@time_job(TIME_LOG)
def build_s_bam_index(input_file, output_file):
    """ Build BAM index. """
    input_bam = input_file.replace('completed', 'gatk')
    snp.build_bam_index(input_bam, output_file)


@follows(build_s_bam_index)
@transform(add_or_replace_read_groups, regex(r"(.*).bam"), r"\1.intervals")
@time_job(TIME_LOG)
def realigner_target_creator(input_file, output_file):
    """ Check Tauqeer's protocol. """
    input_bam = input_file.replace('completed', 'gatk')
    output_intervals = output_file.replace('completed', 'gatk')
    snp.realigner_target_creator(input_bam, output_intervals, output_file)


@follows(realigner_target_creator)
@transform(add_or_replace_read_groups, regex(r"(.*)_s.bam"), r"\1_c.bam",
                                                             r"\1_s.intervals")
@time_job(TIME_LOG)
def indel_realigner(input_file, output_file, intervals):
    """ Check Tauqeer's protocol. """
    input_bam = input_file.replace('completed', 'gatk')
    output_bam = output_file.replace('completed', 'gatk')
    input_intervals = intervals.replace('completed', 'gatk')
    snp.indel_realigner(input_bam, input_intervals, output_bam, output_file)


@follows(indel_realigner)
@transform(indel_realigner, regex(r"(.*).bam"), r"\1s.bam")
@time_job(TIME_LOG)
def sort_sam(input_file, output_file):
    """ Sort the SAM file. """
    input_bam = input_file.replace('completed', 'gatk')
    output_bam = output_file.replace('completed', 'gatk')
    snp.sort_sam(input_bam, output_bam, output_file)


@follows(sort_sam)
@transform(indel_realigner, regex(r"(.*).bam"), r"\1.index")
@time_job(TIME_LOG)
def build_cs_bam_index(input_file, output_file):
    """ Build another BAM index. """
    input_bam = input_file.replace('completed', 'gatk')
    snp.build_bam_index(input_bam, output_file)


@follows(build_cs_bam_index)
@transform(indel_realigner, regex(r"(.*).bam"), r"\1m.bam")
@time_job(TIME_LOG)
def samtools_view(input_file, output_file):
    """ Check Tauqeer's protocol. """
    input_bam = input_file.replace('completed', 'gatk')
    output_bam = output_file.replace('completed', 'gatk')
    snp.samtools_view(input_bam, output_bam, output_file)


@follows(samtools_view)
@transform(samtools_view, regex(r"(.*).bam"), r"\1.index")
@time_job(TIME_LOG)
def build_csm_bam_index(input_file, output_file):
    """ Build BAM index. """
    input_bam = input_file.replace('completed', 'gatk')
    snp.build_bam_index(input_bam, output_file)


@follows(build_csm_bam_index)
@transform(samtools_view, regex(r"(.*).bam"), r"\1.vcf")
@time_job(TIME_LOG)
def unified_genotyper(input_file, output_file):
    """ Check Tauqeer's protocol. """
    input_bam = input_file.replace('completed', 'gatk')
    output_vcf = output_file.replace('completed', 'gatk')
    snp.unified_genotyper(input_bam, output_vcf, output_file)


@follows(unified_genotyper)
@transform(unified_genotyper, regex(r"(.*).vcf"), r"\1c.vcf")
@time_job(TIME_LOG)
def variant_filtration(input_file, output_file):
    """ Check Tauqeer's protocol. """
    input_vcf = input_file.replace('completed', 'gatk')
    output_vcf = output_file.replace('completed', 'gatk')
    snp.variant_filtration(input_vcf, output_vcf, output_file)


@follows(variant_filtration)
@transform(variant_filtration, regex(r"(.*).vcf"), r"\1_annotated.vcf")
@time_job(TIME_LOG)
def vcf_annotator(input_file, output_file):
    """ Annotate the variants. """
    input_vcf = input_file.replace('completed', 'gatk')
    output_vcf = output_file.replace('completed', 'gatk')
    snp.vcf_annotator(input_vcf, output_vcf, output_file)


@follows(vcf_annotator)
@transform(vcf_annotator, regex(r"(.*).vcf"), r"\1.vcf.gz")
@time_job(TIME_LOG)
def move_final_vcf(input_file, output_file):
    """ Move the final annotated VCF to the root of the project. """
    input_vcf = input_file.replace('completed', 'gatk')
    output_vcf = '{0}.variants.vcf.gz'.format(options.tag)
    snp.move_final_vcf(input_vcf, output_vcf, output_file)


@follows(move_final_vcf)
@transform(move_final_vcf, regex(r"(.*).vcf.gz"), r"\1.cleanup")
@time_job(TIME_LOG)
def cleanup(input_file, output_file):
    """ Remove all the intermediate files. """
    base_dir = dirname(input_file.replace('completed', 'gatk'))
    tar_gz = '{0}/gatk/gatk.tar.gz'.format(dirname(base_dir))
    snp.cleanup(base_dir, tar_gz, output_file)

# -----------------------------------------------------------------------------
pipeline_run(exceptions_terminate_immediately=True, verbose=5)
