#! /usr/bin/env python
""" Predict SCCmec presence of a sample. """
from ruffus import *

from staphopia.tasks import sccmec

parser = cmdline.get_argparse(description='Predict SCCmec presence.')
parser.add_argument("-f", "--fastq", dest="fastq", help="Input FASTQ file",
                    required=True)
parser.add_argument("--blastdb", dest="blastdb", required=True,
                    help="BLAST database to query genes against.")
parser.add_argument('-p', '--processors', metavar="INT", type=int, default=1,
                    help='Number of processors to use. (Default 1)')
options = parser.parse_args()
blastdb_exists = options.blastdb + ".out"

# Pipeline --------------------------------------------------------------------


@mkdir('sccmec')
@transform(blastdb_exists, regex(r"(.*)"), r"sccmec/completed.proteins")
def blast_genes(blastdb, output_file):
    """ Blast SCCmec related genes against given blast database. """
    sccmec.blast_genes(options.blastdb, output_file, options.processors)


@follows(blast_genes)
@transform(blastdb_exists, regex(r"(.*)"), r"sccmec/completed.primers")
def blast_primers(blastdb, output_file):
    """ Blast SCCmec related primers against given blast database. """
    sccmec.blast_primers(options.blastdb, output_file)


@mkdir('sccmec/cassettes')
@follows(blast_primers)
@transform(options.fastq, regex(r"(.*)"), r"sccmec/cassettes/completed.sai")
def bwa_aln(input_file, output_file):
    """ Align reads against SCCmec cassettes. """
    sccmec.bwa_aln(options.fastq, output_file, options.processors)


@follows(bwa_aln)
@transform(bwa_aln, regex(r"(.*).sai"), r"\1.sam")
def bwa_samse(input_file, output_file):
    """ Align reads against SCCmec cassettes. """
    sccmec.bwa_samse(input_file, options.fastq, output_file)


@follows(bwa_samse)
@transform(bwa_samse, regex(r"(.*).sam"), r"\1.bam")
def sam_to_bam(input_file, output_file):
    """ Convert SAM  to BAM. """
    sccmec.sam_to_bam(input_file, output_file)


@follows(sam_to_bam)
@transform(sam_to_bam, regex(r"(.*).bam"), r"\1.coverage")
def genome_coverage_bed(input_file, output_file):
    """ Calculate coverage of the alinged reads. """
    sccmec.genome_coverage_bed(input_file, output_file)


@follows(genome_coverage_bed)
@transform(genome_coverage_bed, regex(r"(.*).coverage"), r"\1.cleanup")
def cleanup_mapping(input_file, output_file):
    """ Clean up all the intermediate files. """
    sccmec.cleanup_mapping(output_file)

# -----------------------------------------------------------------------------
pipeline_run(exceptions_terminate_immediately=True, verbose=5)
